"use strict";(function(n,t,i,r){var u={};u.Timer=function(){var n=this;n.start=function(){n.t0=(new Date).getTime()};n.stop=function(){var t=(new Date).getTime(),i=t-n.t0;return n.t0=t,i};n.start()};u.ChangeExpression=new RegExp(/(^(?![><\-])*\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/);u.DiffParser=function(n){for(var t,i,r,f,s=[],h=0,o=n.split(/\n/),e=0;e<o.length;++e)o[e].length!=0&&(t={},i=u.ChangeExpression.exec(o[e]),i!=null)&&(r=i[1].split(","),t["lhs-line-from"]=r[0]-1,t["lhs-line-to"]=r.length==1?r[0]-1:r[1]-1,f=i[3].split(","),t["rhs-line-from"]=f[0]-1,t["rhs-line-to"]=f.length==1?f[0]-1:f[1]-1,t.op=i[2],s[h++]=t);return s};u.sizeOf=function(n){var t=0;for(var i in n)n.hasOwnProperty(i)&&t++;return t};u.LCS=function(n,t){this.x=n.replace(/[ ]{1}/g,"\n");this.y=t.replace(/[ ]{1}/g,"\n")};i.extend(u.LCS.prototype,{clear:function(){this.ready=0},diff:function(n,t){for(var i,s,h,f=new u.diff(this.x,this.y,{ignorews:!1}),c=u.DiffParser(f.normal_form()),r=0,e=0,o=0;o<c.length;++o)i=c[o],i.op!="a"&&(r=f.getLines("lhs").slice(0,i["lhs-line-from"]).join(" ").length,e=i["lhs-line-to"]+1,s=f.getLines("lhs").slice(i["lhs-line-from"],e).join(" "),i.op=="d"?s+=" ":r>0&&i.op=="c"&&(r+=1),t(r,r+s.length)),i.op!="d"&&(r=f.getLines("rhs").slice(0,i["rhs-line-from"]).join(" ").length,e=i["rhs-line-to"]+1,h=f.getLines("rhs").slice(i["rhs-line-from"],e).join(" "),i.op=="a"?h+=" ":r>0&&i.op=="c"&&(r+=1),n(r,r+h.length))}});u.CodeifyText=function(n){this._max_code=0;this._diff_codes={};this.ctxs={};this.options={ignorews:!1};i.extend(this,n);this.lhs=n.lhs.split("\n");this.rhs=n.rhs.split("\n")};i.extend(u.CodeifyText.prototype,{getCodes:function(n){if(!this.ctxs.hasOwnProperty(n)){var t=this._diff_ctx(this[n]);this.ctxs[n]=t;t.codes.length=Object.keys(t.codes).length}return this.ctxs[n].codes},getLines:function(n){return this.ctxs[n].lines},_diff_ctx:function(n){var t={i:0,codes:{},lines:n};return this._codeify(n,t),t},_codeify:function(n,t){for(var r,u,f=this._max_code,i=0;i<n.length;++i)r=n[i],this.options.ignorews&&(r=r.replace(/\s+/g,"")),u=this._diff_codes[r],u!=undefined?t.codes[i]=u:(this._max_code++,this._diff_codes[r]=this._max_code,t.codes[i]=this._max_code)}});u.diff=function(n,t,r){var o=i.extend({ignorews:!1},r);this.codeify=new u.CodeifyText({lhs:n,rhs:t,options:o});var f={codes:this.codeify.getCodes("lhs"),modified:{}},e={codes:this.codeify.getCodes("rhs"),modified:{}},s=f.codes.length+e.codes.length+1;this._lcs(f,0,f.codes.length,e,0,e.codes.length,[],[]);this._optimize(f);this._optimize(e);this.items=this._create_diffs(f,e)};i.extend(u.diff.prototype,{changes:function(){return this.items},getLines:function(n){return this.codeify.getLines(n)},normal_form:function(){for(var f,e,t,i="",r=0;r<this.items.length;++r){var n=this.items[r],o="",s="",u="c";if(n.lhs_deleted_count==0&&n.rhs_inserted_count>0?u="a":n.lhs_deleted_count>0&&n.rhs_inserted_count==0&&(u="d"),o=n.lhs_deleted_count==1?n.lhs_start+1:n.lhs_deleted_count==0?n.lhs_start:n.lhs_start+1+","+(n.lhs_start+n.lhs_deleted_count),s=n.rhs_inserted_count==1?n.rhs_start+1:n.rhs_inserted_count==0?n.rhs_start:n.rhs_start+1+","+(n.rhs_start+n.rhs_inserted_count),i+=o+u+s+"\n",f=this.getLines("lhs"),e=this.getLines("rhs"),e&&f){for(t=n.lhs_start;t<n.lhs_start+n.lhs_deleted_count;++t)i+="< "+f[t]+"\n";for(n.rhs_inserted_count&&n.lhs_deleted_count&&(i+="---\n"),t=n.rhs_start;t<n.rhs_start+n.rhs_inserted_count;++t)i+="> "+e[t]+"\n"}}return i},_lcs:function(n,t,i,r,u,f,e,o){while(t<i&&u<f&&n.codes[t]==r.codes[u])++t,++u;while(t<i&&u<f&&n.codes[i-1]==r.codes[f-1])--i,--f;if(t==i)while(u<f)r.modified[u++]=!0;else if(u==f)while(t<i)n.modified[t++]=!0;else{var s=this._sms(n,t,i,r,u,f,e,o);this._lcs(n,t,s.x,r,u,s.y,e,o);this._lcs(n,s.x,i,r,s.y,f,e,o)}},_sms:function(n,t,i,r,u,f,e,o){var b=n.codes.length+r.codes.length+1,a=t-u,v=i-f,d=i-t-(f-u),k=(d&1)!=0,l=b-a,y=b-v,g=(i-t+f-u)/2+1,w,c,s,h,p;for(o[l+a+1]=t,e[y+v-1]=i,w={x:0,y:0},c=0;c<=g;++c){for(s=a-c;s<=a+c;s+=2){for(s==a-c?h=o[l+s+1]:(h=o[l+s-1]+1,s<a+c&&o[l+s+1]>=h&&(h=o[l+s+1])),p=h-s;h<i&&p<f&&n.codes[h]==r.codes[p];)h++,p++;if(o[l+s]=h,k&&v-c<s&&s<v+c&&e[y+s]<=o[l+s])return w.x=o[l+s],w.y=o[l+s]-s,w}for(s=v-c;s<=v+c;s+=2){for(s==v+c?h=e[y+s-1]:(h=e[y+s+1]-1,s>v-c&&e[y+s-1]<h&&(h=e[y+s-1])),p=h-s;h>t&&p>u&&n.codes[h-1]==r.codes[p-1];)h--,p--;if(e[y+s]=h,!k&&a-c<=s&&s<=a+c&&e[y+s]<=o[l+s])return w.x=o[l+s],w.y=o[l+s]-s,w}}throw"the algorithm should never come here.";},_optimize:function(n){for(var t=0,i=0;t<n.length;){while(t<n.length&&(n.modified[t]==undefined||n.modified[t]==!1))t++;for(i=t;i<n.length&&n.modified[i]==!0;)i++;i<n.length&&n.ctx[t]==n.codes[i]?(n.modified[t]=!1,n.modified[i]=!0):t=i}},_create_diffs:function(n,t){for(var e=[],u=0,f=0,i=0,r=0;i<n.codes.length||r<t.codes.length;)if(i<n.codes.length&&!n.modified[i]&&r<t.codes.length&&!t.modified[r])i++,r++;else{for(u=i,f=r;i<n.codes.length&&(r>=t.codes.length||n.modified[i]);)i++;while(r<t.codes.length&&(i>=n.codes.length||t.modified[r]))r++;(u<i||f<r)&&e.push({lhs_start:u,rhs_start:f,lhs_deleted_count:i-u,rhs_inserted_count:r-f})}return e}});u.mergely=function(n,t){n&&this.init(n,t)};i.extend(u.mergely.prototype,{name:"mergely",init:function(n,t){this.diffView=new u.CodeMirrorDiffView(n,t);this.bind(n)},bind:function(n){this.diffView.bind(n)}});u.CodeMirrorDiffView=function(n,t){r.defineExtension("centerOnCursor",function(){var n=this.cursorCoords(null,"local");this.scrollTo(null,(n.y+n.yBot)/2-this.getScrollerElement().clientHeight/2)});this.init(n,t)};i.extend(u.CodeMirrorDiffView.prototype,{init:function(n,t){this.settings={autoupdate:!0,autoresize:!0,rhs_margin:"right",lcs:!0,sidebar:!0,viewport:!1,ignorews:!1,fadein:"fast",editor_width:"650px",editor_height:"400px",resize_timeout:500,change_timeout:150,fgcolor:{a:"#4ba3fa",c:"#a3a3a3",d:"#ff7f7f",ca:"#4b73ff",cc:"#434343",cd:"#ff4f4f"},bgcolor:"#eee",vpcolor:"rgba(0, 0, 200, 0.5)",lhs:function(){},rhs:function(){},loaded:function(){},_auto_width:function(n){return n},resize:function(t){var s=t?16:0,u=i(n).parent().width()+s,f=0;this.width&&this.width!="auto"?(u=this.width,this.editor_width=u):u=this._auto_width(u);this.height&&this.height!="auto"?(f=this.height,this.editor_height=f):f=i(n).parent().height();var e=u/2-24,o=f,r=i(n);r.find(".mergely-column").css({width:e+"px"});r.find(".mergely-column, .mergely-canvas, .mergely-margin, .mergely-column textarea, .CodeMirror-scroll, .cm-s-default").css({height:o+"px"});r.find(".mergely-canvas").css({height:o+"px"});r.find(".mergely-column textarea").css({width:e+"px"});r.css({width:u,height:f,clear:"both"});r.css("display")=="none"&&(this.fadein!=!1?r.fadeIn(this.fadein):r.show(),this.loaded&&this.loaded());this.resized&&this.resized()},_debug:"",resized:function(){}};var r={mode:"text/plain",readOnly:!1,lineWrapping:!1,lineNumbers:!0,gutters:["merge","CodeMirror-linenumbers"]};this.lhs_cmsettings={};this.rhs_cmsettings={};this.element=i(n);t&&t.cmsettings&&i.extend(this.lhs_cmsettings,r,t.cmsettings,t.lhs_cmsettings);t&&t.cmsettings&&i.extend(this.rhs_cmsettings,r,t.cmsettings,t.rhs_cmsettings);this.element.bind("destroyed",i.proxy(this.teardown,this));i.data(n,"mergely",this);this._setOptions(t)},unbind:function(){this.changed_timeout!=null&&clearTimeout(this.changed_timeout);this.editor[this.id+"-lhs"].toTextArea();this.editor[this.id+"-rhs"].toTextArea();i(n).off(".mergely")},destroy:function(){this.element.unbind("destroyed",this.teardown);this.teardown()},teardown:function(){this.unbind()},lhs:function(n){this.editor[this.id+"-lhs"].setValue(n)},rhs:function(n){this.editor[this.id+"-rhs"].setValue(n)},update:function(){this._changing(this.id+"-lhs",this.id+"-rhs")},unmarkup:function(){this._clear()},scrollToDiff:function(n){this.changes.length&&(this._current_diff=n=="next"?Math.min(++this._current_diff,this.changes.length-1):Math.max(--this._current_diff,0),this._scroll_to_change(this.changes[this._current_diff]),this._changed(this.id+"-lhs",this.id+"-rhs"))},mergeCurrentChange:function(n){this.changes.length&&(n!="lhs"||this.lhs_cmsettings.readOnly?n!="rhs"||this.rhs_cmsettings.readOnly||this._merge_change(this.changes[this._current_diff],"lhs","rhs"):this._merge_change(this.changes[this._current_diff],"rhs","lhs"))},scrollTo:function(n,t){var i=this.editor[this.id+"-lhs"],r=this.editor[this.id+"-rhs"];n=="lhs"?(i.setCursor(t),i.centerOnCursor()):(r.setCursor(t),r.centerOnCursor())},_setOptions:function(n){if(i.extend(this.settings,n),this.settings.hasOwnProperty("rhs_margin"))if(this.settings.rhs_margin=="left")this.element.find(".mergely-margin:last-child").insertAfter(this.element.find(".mergely-canvas"));else{var t=this.element.find(".mergely-margin").last();t.appendTo(t.parent())}this.settings.hasOwnProperty("sidebar")&&(this.settings.sidebar?i(this.element).find(".mergely-margin").css({display:"block"}):i(this.element).find(".mergely-margin").css({display:"none"}))},options:function(n){if(n)this._setOptions(n),this.settings.autoresize&&this.resize(),this.settings.autoupdate&&this.update();else return this.settings},swap:function(){if(!this.lhs_cmsettings.readOnly&&!this.rhs_cmsettings.readOnly){var n=this.editor[this.id+"-lhs"],t=this.editor[this.id+"-rhs"],i=t.getValue();t.setValue(n.getValue());n.setValue(i)}},merge:function(n){var t=this.editor[this.id+"-lhs"],i=this.editor[this.id+"-rhs"];n!="lhs"||this.lhs_cmsettings.readOnly?this.rhs_cmsettings.readOnly||i.setValue(t.getValue()):t.setValue(i.getValue())},get:function(n){var i=this.editor[this.id+"-"+n],t=i.getValue();return t==undefined?"":t},clear:function(n){if((n!="lhs"||!this.lhs_cmsettings.readOnly)&&(n!="rhs"||!this.rhs_cmsettings.readOnly)){var t=this.editor[this.id+"-"+n];t.setValue("")}},cm:function(n){return this.editor[this.id+"-"+n]},search:function(n,t,i){var f=this.editor[this.id+"-lhs"],e=this.editor[this.id+"-rhs"],r,u;r=n=="lhs"?f:e;i=i=="prev"?"findPrevious":"findNext";(r.getSelection().length==0||this.prev_query[n]!=t)&&(this.cursor[this.id]=r.getSearchCursor(t,{line:0,ch:0},!1),this.prev_query[n]=t);u=this.cursor[this.id];u[i]()?r.setSelection(u.from(),u.to()):u=r.getSearchCursor(t,{line:0,ch:0},!1)},resize:function(){this.settings.resize();this._changing(this.id+"-lhs",this.id+"-rhs");this._set_top_offset(this.id+"-lhs")},diff:function(){var n=this.editor[this.id+"-lhs"].getValue(),t=this.editor[this.id+"-rhs"].getValue(),i=new u.diff(n,t,this.settings);return i.normal_form()},bind:function(t){var c,l,a,f,v,y,e,o,w,u,s,p,h;if(this.element.hide(),this.id=i(t).attr("id"),this.changed_timeout=null,this.chfns={},this.chfns[this.id+"-lhs"]=[],this.chfns[this.id+"-rhs"]=[],this.prev_query=[],this.cursor=[],this._skipscroll={},this.change_exp=new RegExp(/(\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/),i.button!=undefined?(c='<button title="Merge left"><\/button>',l='<button title="Merge right"><\/button>'):(a="opacity:0.4;width:10px;height:15px;background-color:#888;cursor:pointer;text-align:center;color:#eee;border:1px solid: #222;margin-right:5px;margin-top: -2px;",c='<div style="'+a+'" title="Merge left">&lt;<\/div>',l='<div style="'+a+'" title="Merge right">&gt;<\/div>'),this.merge_rhs_button=i(l),this.merge_lhs_button=i(c),f=this.settings.editor_height,v=this.settings.editor_width,this.element.append(i('<div class="mergely-margin" style="height: '+f+'"><canvas id="'+this.id+'-lhs-margin" width="8px" height="'+f+'"><\/canvas><\/div>')),this.element.append(i('<div style="position:relative;width:'+v+"; height:"+f+'" id="'+this.id+'-editor-lhs" class="mergely-column"><textarea style="" id="'+this.id+'-lhs"><\/textarea><\/div>')),this.element.append(i('<div class="mergely-canvas" style="height: '+f+'"><canvas id="'+this.id+"-lhs-"+this.id+'-rhs-canvas" style="width:28px" width="28px" height="'+f+'"><\/canvas><\/div>')),y=i('<div class="mergely-margin" style="height: '+f+'"><canvas id="'+this.id+'-rhs-margin" width="8px" height="'+f+'"><\/canvas><\/div>'),this.settings.sidebar||this.element.find(".mergely-margin").css({display:"none"}),this.settings.rhs_margin=="left"&&this.element.append(y),this.element.append(i('<div style="width:'+v+"; height:"+f+'" id="'+this.id+'-editor-rhs" class="mergely-column"><textarea style="" id="'+this.id+'-rhs"><\/textarea><\/div>')),this.settings.rhs_margin!="left"&&this.element.append(y),e="#"+this.id+" .CodeMirror-gutter-text { padding: 5px 0 0 0; }#"+this.id+" .CodeMirror-lines pre, #"+this.id+" .CodeMirror-gutter-text pre { line-height: 18px; }.CodeMirror-linewidget { overflow: hidden; };",this.settings.autoresize&&(e+=this.id+" .CodeMirror-scroll { height: 100%; overflow: auto; }"),e+="\n.CodeMirror { line-height: 18px; }",i('<style type="text/css">'+e+"<\/style>").appendTo("head"),o=i("#"+this.id+"-rhs").get(0),!o){console.error("rhs textarea not defined - Mergely not initialized properly");return}if(w=i("#"+this.id+"-lhs").get(0),!o){console.error("lhs textarea not defined - Mergely not initialized properly");return}u=this;this.editor=[];this.editor[this.id+"-lhs"]=r.fromTextArea(w,this.lhs_cmsettings);this.editor[this.id+"-rhs"]=r.fromTextArea(o,this.rhs_cmsettings);this.editor[this.id+"-lhs"].on("change",function(){u.settings.autoupdate&&u._changing(u.id+"-lhs",u.id+"-rhs")});this.editor[this.id+"-lhs"].on("scroll",function(){u._scrolling(u.id+"-lhs")});this.editor[this.id+"-rhs"].on("change",function(){u.settings.autoupdate&&u._changing(u.id+"-lhs",u.id+"-rhs")});this.editor[this.id+"-rhs"].on("scroll",function(){u._scrolling(u.id+"-rhs")});if(this.settings.autoresize){s=null;p=function(n){u.settings.resize&&u.settings.resize(n);u.editor[u.id+"-lhs"].refresh();u.editor[u.id+"-rhs"].refresh();u.settings.autoupdate&&u._changing(u.id+"-lhs",u.id+"-rhs")};i(n).on("resize.mergely",function(){s&&clearTimeout(s);s=setTimeout(p,u.settings.resize_timeout)});p(!0)}this.settings.lhs&&(h=this.editor[this.id+"-lhs"].getDoc().setValue,this.settings.lhs(h.bind(this.editor[this.id+"-lhs"].getDoc())));this.settings.rhs&&(h=this.editor[this.id+"-rhs"].getDoc().setValue,this.settings.rhs(h.bind(this.editor[this.id+"-rhs"].getDoc())))},_scroll_to_change:function(n){if(n){var t=this,i=t.editor[t.id+"-lhs"],r=t.editor[t.id+"-rhs"],u=i.getScrollerElement().offsetHeight*.5;i.setCursor(Math.max(n["lhs-line-from"],0),0);r.setCursor(Math.max(n["rhs-line-from"],0),0);i.scrollTo(null,0);r.scrollTo(null,0);t._calculate_offsets(t.id+"-lhs",t.id+"-rhs",[n]);i.scrollTo(null,Math.max(n["lhs-y-start"]-u,0));r.scrollTo(null,Math.max(n["rhs-y-start"]-u,0))}},_scrolling:function(n){var e,s,h,r,a,t,b,v,y;if(this._skipscroll[n]===!0){this._skipscroll[n]=!1;return}e=i(this.editor[n].getScrollerElement());this.midway==undefined&&(this.midway=(e.height()/2+e.offset().top).toFixed(2));var o=this.editor[n].coordsChar({left:0,top:this.midway}),p=e.scrollTop(),k=e.scrollLeft();this.trace("scroll","side",n);this.trace("scroll","midway",this.midway);this.trace("scroll","midline",o);this.trace("scroll","top_to",p);this.trace("scroll","left_to",k);s=this.id+"-lhs";h=this.id+"-rhs";for(r in this.editor)if(this.editor.hasOwnProperty(r)&&n!=r){var f=n.replace(this.id+"-",""),c=r.replace(this.id+"-",""),w=0,l=null,d=!1;for(a=0;a<this.changes.length;++a)t=this.changes[a],o.line>=t[f+"-line-from"]&&(l=t,o.line>=l[f+"-line-to"]&&(t.hasOwnProperty(f+"-y-start")&&t.hasOwnProperty(f+"-y-end")&&t.hasOwnProperty(c+"-y-start")&&t.hasOwnProperty(c+"-y-end")?w+=t[f+"-y-end"]-t[f+"-y-start"]-(t[c+"-y-end"]-t[c+"-y-start"]):d=!0));b=this.editor[r].getViewport();v=!0;l&&(this.trace("scroll","last change before midline",l),o.line>=b.from&&o<=b.to&&(v=!1));this.trace("scroll","scroll",v);v||d?(this.trace("scroll","scrolling other side",p-w),this._skipscroll[r]=!0,this.editor[r].scrollTo(k,p-w)):this.trace("scroll","not scrolling other side");this.settings.autoupdate&&(y=new u.Timer,this._calculate_offsets(s,h,this.changes),this.trace("change","offsets time",y.stop()),this._markup_changes(s,h,this.changes),this.trace("change","markup time",y.stop()),this._draw_diff(s,h,this.changes),this.trace("change","draw time",y.stop()));this.trace("scroll","scrolled")}},_changing:function(n,t){this.trace("change","changing-timeout",this.changed_timeout);var i=this;this.changed_timeout!=null&&clearTimeout(this.changed_timeout);this.changed_timeout=setTimeout(function(){var r=new u.Timer;i._changed(n,t);i.trace("change","total time",r.stop())},this.settings.change_timeout)},_changed:function(n,t){this._clear();this._diff(n,t)},_clear:function(){var o=this,i,r,h,l,n,s,a,v=function(){for(l=new u.Timer,n=0,a=r.lineCount();n<a;++n)r.removeLineClass(n,"background");for(n=0;n<h.length;++n)s=h[n],s.lines.length&&o.trace("change","clear text",s.lines[0].text),s.clear();r.clearGutter("merge");o.trace("change","clear time",l.stop())};for(i in this.editor)this.editor.hasOwnProperty(i)&&(r=this.editor[i],h=o.chfns[i],r.operation(v));o.chfns[i]=[];var t=this._draw_info(this.id+"-lhs",this.id+"-rhs"),f=t.clhs.get(0).getContext("2d"),e=t.crhs.get(0).getContext("2d"),c=t.dcanvas.getContext("2d");f.beginPath();f.fillStyle=this.settings.bgcolor;f.strokeStyle="#888";f.fillRect(0,0,6.5,t.visible_page_height);f.strokeRect(0,0,6.5,t.visible_page_height);e.beginPath();e.fillStyle=this.settings.bgcolor;e.strokeStyle="#888";e.fillRect(0,0,6.5,t.visible_page_height);e.strokeRect(0,0,6.5,t.visible_page_height);c.beginPath();c.fillStyle="#fff";c.fillRect(0,0,this.draw_mid_width,t.visible_page_height)},_diff:function(n,t){var r=this.editor[n].getValue(),f=this.editor[t].getValue(),i=new u.Timer,e=new u.diff(r,f,this.settings);this.trace("change","diff time",i.stop());this.changes=u.DiffParser(e.normal_form());this.trace("change","parse time",i.stop());this._current_diff===undefined&&(this._current_diff=0,this._scroll_to_change(this.changes[0]));this.trace("change","scroll_to_change time",i.stop());this._calculate_offsets(n,t,this.changes);this.trace("change","offsets time",i.stop());this._markup_changes(n,t,this.changes);this.trace("change","markup time",i.stop());this._draw_diff(n,t,this.changes);this.trace("change","draw time",i.stop())},_parse_diff:function(n,t,i){var u,r,f,e,o;this.trace("diff","diff results:\n",i);var h=[],c=0,s=i.split(/\n/);for(u=0;u<s.length;++u)s[u].length!=0&&(r={},f=this.change_exp.exec(s[u]),f!=null)&&(e=f[1].split(","),r["lhs-line-from"]=e[0]-1,r["lhs-line-to"]=e.length==1?e[0]-1:e[1]-1,o=f[3].split(","),r["rhs-line-from"]=o[0]-1,r["rhs-line-to"]=o.length==1?o[0]-1:o[1]-1,r["lhs-line-from"]<0&&(r["lhs-line-from"]=0),r["lhs-line-to"]<0&&(r["lhs-line-to"]=0),r["rhs-line-from"]<0&&(r["rhs-line-from"]=0),r["rhs-line-to"]<0&&(r["rhs-line-to"]=0),r.op=f[2],h[c++]=r,this.trace("diff","change",r));return h},_get_viewport:function(n,t){var i=this.editor[n].getViewport(),r=this.editor[t].getViewport();return{from:Math.min(i.from,r.from),to:Math.max(i.to,r.to)}},_is_change_in_view:function(n,t){return this.settings.viewport?t["lhs-line-from"]<n.from&&t["lhs-line-to"]<n.to||t["lhs-line-from"]>n.from&&t["lhs-line-to"]>n.to||t["rhs-line-from"]<n.from&&t["rhs-line-to"]<n.to||t["rhs-line-from"]>n.from&&t["rhs-line-to"]>n.to?!1:!0:!0},_set_top_offset:function(n){var u=this.editor[n].getScrollInfo().top,r,t;return(this.editor[n].scrollTo(null,0),r=i("#"+this.id+" .CodeMirror-measure").first(),t=r.offset().top-4,!t)?!1:(this.editor[n].scrollTo(null,u),this.draw_top_offset=.5-t,!0)},_calculate_offsets:function(n,t,r){var k,h,u;if(this.em_height==null){if(!this._set_top_offset(n))return;if(this.em_height=this.editor[n].defaultTextHeight(),this.em_height||(console.warn("Failed to calculate offsets, using 18 by default"),this.em_height=18),this.draw_lhs_min=.5,k=i("#"+n+"-"+t+"-canvas"),k.length||console.error("failed to find canvas","#"+n+"-"+t+"-canvas"),!k.width()){console.error("canvas width is 0");return}this.draw_mid_width=i("#"+n+"-"+t+"-canvas").width();this.draw_rhs_max=this.draw_mid_width-.5;this.draw_lhs_width=5;this.draw_rhs_width=5;this.trace("calc","change offsets calculated",{top_offset:this.draw_top_offset,lhs_min:this.draw_lhs_min,rhs_max:this.draw_rhs_max,lhs_width:this.draw_lhs_width,rhs_width:this.draw_rhs_width})}var y=this.editor[n].charCoords({line:0}),p=this.editor[t].charCoords({line:0}),it=this._get_viewport(n,t);for(h=0;h<r.length;++h){if(u=r[h],!this.settings.sidebar&&!this._is_change_in_view(it,u)){delete u["lhs-y-start"];delete u["lhs-y-end"];delete u["rhs-y-start"];delete u["rhs-y-end"];continue}var c=u["lhs-line-from"]>=0?u["lhs-line-from"]:0,w=u["lhs-line-to"]>=0?u["lhs-line-to"]:0,l=u["rhs-line-from"]>=0?u["rhs-line-from"]:0,b=u["rhs-line-to"]>=0?u["rhs-line-to"]:0,f,a,e,v,o,s,d,g,nt,tt;this.editor[n].getOption("lineWrapping")||this.editor[t].getOption("lineWrapping")?(o=this.editor[n].cursorCoords({line:c,ch:0},"page"),g=this.editor[n].getLineHandle(c),f={top:o.top,bottom:o.top+g.height},s=this.editor[n].cursorCoords({line:w,ch:0},"page"),d=this.editor[n].getLineHandle(w),a={top:s.top,bottom:s.top+d.height},o=this.editor[t].cursorCoords({line:l,ch:0},"page"),nt=this.editor[t].getLineHandle(l),e={top:o.top,bottom:o.top+nt.height},s=this.editor[t].cursorCoords({line:b,ch:0},"page"),tt=this.editor[t].getLineHandle(b),v={top:s.top,bottom:s.top+tt.height}):(f={top:y.top+c*this.em_height,bottom:y.bottom+c*this.em_height+2},a={top:y.top+w*this.em_height,bottom:y.bottom+w*this.em_height+2},e={top:p.top+l*this.em_height,bottom:p.bottom+l*this.em_height+2},v={top:p.top+b*this.em_height,bottom:p.bottom+b*this.em_height+2});u.op=="a"?l>0&&(f.top=f.bottom,f.bottom+=this.em_height,a=f):u.op=="d"&&c>0&&(e.top=e.bottom,e.bottom+=this.em_height,v=e);u["lhs-y-start"]=this.draw_top_offset+f.top;u["lhs-y-end"]=u.op=="c"||u.op=="d"?this.draw_top_offset+a.bottom:this.draw_top_offset+a.top;u["rhs-y-start"]=this.draw_top_offset+e.top;u["rhs-y-end"]=u.op=="c"||u.op=="a"?this.draw_top_offset+v.bottom:this.draw_top_offset+v.top;this.trace("calc","change calculated",h,u)}return r},_markup_changes:function(n,t,r){var w,l,v,o,s,b,y,p,rt,d;i(".merge-button").remove();var c=this,f=this.editor[n],e=this.editor[t],a=new u.Timer;for(f.operation(function(){for(var o,u,t=0;t<r.length;++t){var n=r[t],i=n["lhs-line-from"]>=0?n["lhs-line-from"]:0,s=n["lhs-line-to"]>=0?n["lhs-line-to"]:0,l=n["rhs-line-from"]>=0?n["rhs-line-from"]:0,a=n["rhs-line-to"]>=0?n["rhs-line-to"]:0,h=["mergely","lhs",n.op,"cid-"+t];if(f.addLineClass(i,"background","start"),f.addLineClass(s,"background","end"),i==0&&s==0&&l==0)f.addLineClass(i,"background",h.join(" ")),f.addLineClass(i,"background","first");else for(o=i;o<=s;++o)f.addLineClass(o,"background",h.join(" ")),f.addLineClass(o,"background",h.join(" "));e.getOption("readOnly")||(u=c.merge_rhs_button.clone(),u.button&&u.button({icons:{primary:"ui-icon-triangle-1-e"},text:!1}),u.addClass("merge-button"),u.attr("id","merge-rhs-"+t),f.setGutterMarker(i,"merge",u.get(0)))}}),w=this._get_viewport(n,t),this.trace("change","markup lhs-editor time",a.stop()),e.operation(function(){for(var s,o,u,t=0;t<r.length;++t){var n=r[t],l=n["lhs-line-from"]>=0?n["lhs-line-from"]:0,a=n["lhs-line-to"]>=0?n["lhs-line-to"]:0,i=n["rhs-line-from"]>=0?n["rhs-line-from"]:0,h=n["rhs-line-to"]>=0?n["rhs-line-to"]:0;if(c._is_change_in_view(w,n)){if(s=["mergely","rhs",n.op,"cid-"+t],e.addLineClass(i,"background","start"),e.addLineClass(h,"background","end"),i==0&&h==0&&l==0)e.addLineClass(i,"background",s.join(" ")),e.addLineClass(i,"background","first");else for(o=i;o<=h;++o)e.addLineClass(o,"background",s.join(" ")),e.addLineClass(o,"background",s.join(" "));f.getOption("readOnly")||(u=c.merge_lhs_button.clone(),u.button&&u.button({icons:{primary:"ui-icon-triangle-1-w"},text:!1}),u.addClass("merge-button"),u.attr("id","merge-lhs-"+t),e.setGutterMarker(i,"merge",u.get(0)))}}}),this.trace("change","markup rhs-editor time",a.stop()),l=[],v=0;this.settings.lcs&&v<r.length;++v){var h=r[v],g=h["lhs-line-from"]>=0?h["lhs-line-from"]:0,k=h["lhs-line-to"]>=0?h["lhs-line-to"]:0,ut=h["rhs-line-from"]>=0?h["rhs-line-from"]:0,nt=h["rhs-line-to"]>=0?h["rhs-line-to"]:0;if(this._is_change_in_view(w,h))if(h.op=="d"){var ft=g,tt=k,it=f.lineInfo(tt);it&&l.push([f,{line:ft,ch:0},{line:tt,ch:it.text.length},{className:"mergely ch d lhs"}])}else if(h.op=="c")for(o=g,s=ut,b=0;o>=0&&o<=k||s>=0&&s<=nt;++o,++s){if(s+b>nt){y=f.getLine(o);l.push([f,{line:o,ch:0},{line:o,ch:y.length},{className:"mergely ch d lhs"}]);continue}if(o+b>k){p=e.getLine(s);l.push([e,{line:s,ch:0},{line:s,ch:p.length},{className:"mergely ch a rhs"}]);continue}y=f.getLine(o);p=e.getLine(s);rt=new u.LCS(y,p);rt.diff(function(n,t){l.push([e,{line:s,ch:n},{line:s,ch:t},{className:"mergely ch a rhs"}])},function(n,t){l.push([f,{line:o,ch:n},{line:o,ch:t},{className:"mergely ch d lhs"}])})}}this.trace("change","LCS marktext time",a.stop());f.operation(function(){for(var n,t=0;t<l.length;++t)(n=l[t],n[0].doc.id==f.getDoc().id)&&c.chfns[c.id+"-lhs"].push(n[0].markText(n[1],n[2],n[3]))});e.operation(function(){for(var n,t=0;t<l.length;++t)(n=l[t],n[0].doc.id==e.getDoc().id)&&c.chfns[c.id+"-rhs"].push(n[0].markText(n[1],n[2],n[3]))});this.trace("change","LCS markup time",a.stop());d={lhs:f,rhs:e};i(".merge-button").on("click",function(n){var t="rhs",r="lhs",e=i(this).parents("#"+c.id+"-editor-lhs"),f;e.length&&(t="lhs",r="rhs");var o=d[t].coordsChar({left:n.pageX,top:n.pageY}),u=null,s=d[t].lineInfo(o.line);return i.each(s.bgClass.split(" "),function(n,t){if(t.indexOf("cid-")==0)return u=parseInt(t.split("-")[1],10),!1}),f=c.changes[u],c._merge_change(f,t,r),!1});this.trace("change","markup buttons time",a.stop())},_merge_change:function(n,t,i){if(n){var h=this.editor[this.id+"-lhs"],c=this.editor[this.id+"-rhs"],u={lhs:h,rhs:c},f,e,o,s=u[t].getRange(r.Pos(n[t+"-line-from"],0),r.Pos(n[t+"-line-to"]+1,0));if(n.op=="c")u[i].replaceRange(s,r.Pos(n[i+"-line-from"],0),r.Pos(n[i+"-line-to"]+1,0));else if(t=="rhs")if(n.op=="a")u[i].replaceRange(s,r.Pos(n[i+"-line-from"]+1,0),r.Pos(n[i+"-line-to"]+1,0));else for(e=parseInt(n[i+"-line-from"],10),o=parseInt(n[i+"-line-to"],10),f=o;f>=e;--f)u[i].setCursor({line:f,ch:-1}),u[i].execCommand("deleteLine");else if(t=="lhs")if(n.op=="a")for(e=parseInt(n[i+"-line-from"],10),o=parseInt(n[i+"-line-to"],10),f=o;f>=e;--f)u[i].setCursor({line:f,ch:-1}),u[i].execCommand("deleteLine");else u[i].replaceRange(s,r.Pos(n[i+"-line-from"]+1,0));u.lhs.setValue(u.lhs.getValue());u.rhs.setValue(u.rhs.getValue());this._scroll_to_change(n)}},_draw_info:function(n,r){var u=i(this.editor[n].getScrollerElement()).height(),f=i(this.editor[n].getScrollerElement()).children(":first-child").height(),s=t.getElementById(n+"-"+r+"-canvas"),e,o;if(s==undefined)throw"Failed to find: "+n+"-"+r+"-canvas";return e=i("#"+this.id+"-lhs-margin"),o=i("#"+this.id+"-rhs-margin"),{visible_page_height:u,gutter_height:f,visible_page_ratio:u/f,margin_ratio:u/f,lhs_scroller:i(this.editor[n].getScrollerElement()),rhs_scroller:i(this.editor[r].getScrollerElement()),lhs_lines:this.editor[n].lineCount(),rhs_lines:this.editor[r].lineCount(),dcanvas:s,clhs:e,crhs:o,lhs_xyoffset:i(e).offset(),rhs_xyoffset:i(o).offset()}},_draw_diff:function(n,t,r){var u=this._draw_info(n,t),rt=u.clhs.get(0),ut=u.crhs.get(0),f=u.dcanvas.getContext("2d"),h=rt.getContext("2d"),c=ut.getContext("2d"),ft,w,s,y;for(this.trace("draw","visible_page_height",u.visible_page_height),this.trace("draw","gutter_height",u.gutter_height),this.trace("draw","visible_page_ratio",u.visible_page_ratio),this.trace("draw","lhs-scroller-top",u.lhs_scroller.scrollTop()),this.trace("draw","rhs-scroller-top",u.rhs_scroller.scrollTop()),i.each(i.find("#"+this.id+" canvas"),function(){i(this).get(0).height=u.visible_page_height}),u.clhs.unbind("click"),u.crhs.unbind("click"),h.beginPath(),h.fillStyle=this.settings.bgcolor,h.strokeStyle="#888",h.fillRect(0,0,6.5,u.visible_page_height),h.strokeRect(0,0,6.5,u.visible_page_height),c.beginPath(),c.fillStyle=this.settings.bgcolor,c.strokeStyle="#888",c.fillRect(0,0,6.5,u.visible_page_height),c.strokeRect(0,0,6.5,u.visible_page_height),ft=this._get_viewport(n,t),w=0;w<r.length;++w){s=r[w];this.trace("draw",s);var l=(s["lhs-y-start"]+u.lhs_scroller.scrollTop())*u.visible_page_ratio,b=(s["lhs-y-end"]+u.lhs_scroller.scrollTop())*u.visible_page_ratio+1,a=(s["rhs-y-start"]+u.rhs_scroller.scrollTop())*u.visible_page_ratio,k=(s["rhs-y-end"]+u.rhs_scroller.scrollTop())*u.visible_page_ratio+1;if(this.trace("draw","marker calculated",l,b,a,k),h.beginPath(),h.fillStyle=this.settings.fgcolor[(this._current_diff==w?"c":"")+s.op],h.strokeStyle="#000",h.lineWidth=.5,h.fillRect(1.5,l,4.5,Math.max(b-l,5)),h.strokeRect(1.5,l,4.5,Math.max(b-l,5)),c.beginPath(),c.fillStyle=this.settings.fgcolor[(this._current_diff==w?"c":"")+s.op],c.strokeStyle="#000",c.lineWidth=.5,c.fillRect(1.5,a,4.5,Math.max(k-a,5)),c.strokeRect(1.5,a,4.5,Math.max(k-a,5)),this._is_change_in_view(ft,s)){l=s["lhs-y-start"];b=s["lhs-y-end"];a=s["rhs-y-start"];k=s["rhs-y-end"];y=3;f.beginPath();f.strokeStyle=this.settings.fgcolor[(this._current_diff==w?"c":"")+s.op];f.lineWidth=this._current_diff==w?1.5:1;var v=this.draw_lhs_width,p=b-l-1,e=this.draw_lhs_min,o=l;f.moveTo(e,o);navigator.appName=="Microsoft Internet Explorer"?(f.lineTo(this.draw_lhs_min+this.draw_lhs_width,l),f.lineTo(this.draw_lhs_min+this.draw_lhs_width,b+1),f.lineTo(this.draw_lhs_min,b+1)):(p<=0?f.lineTo(e+v,o):(f.arcTo(e+v,o,e+v,o+y,y),f.arcTo(e+v,o+p,e+v-y,o+p,y)),f.lineTo(e,o+p));f.stroke();v=this.draw_rhs_width;p=k-a-1;e=this.draw_rhs_max;o=a;f.moveTo(e,o);navigator.appName=="Microsoft Internet Explorer"?(f.lineTo(this.draw_rhs_max-this.draw_rhs_width,a),f.lineTo(this.draw_rhs_max-this.draw_rhs_width,k+1),f.lineTo(this.draw_rhs_max,k+1)):(p<=0?f.lineTo(e-v,o):(f.arcTo(e-v,o,e-v,o+y,y),f.arcTo(e-v,o+p,e-y,o+p,y)),f.lineTo(e,o+p));f.stroke();var et=this.draw_lhs_min+this.draw_lhs_width,g=l+(b+1-l)/2,nt=this.draw_rhs_max-this.draw_rhs_width,d=a+(k+1-a)/2;f.moveTo(et,g);g==d?f.lineTo(nt,d):f.bezierCurveTo(et+12,g-3,nt-12,d-3,nt,d);f.stroke()}}h.fillStyle=this.settings.vpcolor;c.fillStyle=this.settings.vpcolor;var tt=u.clhs.height()*u.visible_page_ratio,ot=u.lhs_scroller.scrollTop()/u.gutter_height*u.clhs.height(),it=u.crhs.height()*u.visible_page_ratio,st=u.rhs_scroller.scrollTop()/u.gutter_height*u.crhs.height();this.trace("draw","cls.height",u.clhs.height());this.trace("draw","lhs_scroller.scrollTop()",u.lhs_scroller.scrollTop());this.trace("draw","gutter_height",u.gutter_height);this.trace("draw","visible_page_ratio",u.visible_page_ratio);this.trace("draw","lhs from",ot,"lhs to",tt);this.trace("draw","rhs from",st,"rhs to",it);h.fillRect(1.5,ot,4.5,tt);c.fillRect(1.5,st,4.5,it);u.clhs.click(function(n){var t=n.pageY-u.lhs_xyoffset.top-tt/2,i=Math.max(0,t/rt.height*u.lhs_scroller.get(0).scrollHeight);u.lhs_scroller.scrollTop(i)});u.crhs.click(function(n){var t=n.pageY-u.rhs_xyoffset.top-it/2,i=Math.max(0,t/ut.height*u.rhs_scroller.get(0).scrollHeight);u.rhs_scroller.scrollTop(i)})},trace:function(n){this.settings._debug.indexOf(n)>=0&&(arguments[0]=n+":",console.log([].slice.apply(arguments)))}});i.pluginMaker=function(n){i.fn[n.prototype.name]=function(t){var u=i.makeArray(arguments),f=u.slice(1),r;return this.each(function(){var e=i.data(this,n.prototype.name),o;if(e){if(typeof t=="string")r=e[t].apply(e,f);else if(e.update)return e.update.apply(e,u)}else o=new n(this,t)}),r!=undefined?r:void 0}};i.pluginMaker(u.mergely)})(window,document,jQuery,CodeMirror);